<?php

/**
 * Implements hook_wysiwyg_editor_settings_alter()
 */
function iied_features_wysiwyg_editor_settings_alter(&$settings, $context) {

  // The $context variable contains information about the wysiwyg profile we're using
  // In this case we just need to check that the editor being used is ckeditor

  if ($context['profile']->editor == 'ckeditor') {

    $settings['removeFormatAttributes'] = 'class,style,lang,width,height,align,hspace,valign,target';
    $settings['pasteFromWordPromptCleanup'] = true;
 	$settings['allowedContent'] = true;
  }
}


/**
 * Implements hook_language_switch_links_alter
 *
 * Unset lang-switcher links for non-existent translations.
 */
function iied_features_language_switch_links_alter(array &$links, $type, $path) {
  $node = menu_get_object();
  if ($node) {
    // Unset lang-switcher links for non-existent translations
    foreach ($links as $langcode => &$link) {
      if (!isset($node->translations->data[$langcode])) {
        unset($links[$langcode]);
      }
      $link['attributes']['hreflang'] = $langcode;
    }
  }
  $term = menu_get_object('taxonomy_term', 2);
  if ($term) {
    // User is on a taxonomy term page
    foreach ($links as $langcode => &$link) {
      if (is_numeric(strpos(drupal_get_path_alias($links[$langcode]['href'], $langcode), 'taxonomy/term/'))) {
        // No translation exists as no alias has been created
        unset($links[$langcode]);
      }
      $link['attributes']['hreflang'] = $langcode;
    }
  }
  foreach ($links as $langcode => &$link) {
    switch ($langcode) {
      case 'en':
        $links[$langcode]['title'] = t('View this page in English');
        break;
      case 'de':
        $links[$langcode]['title'] = t('Diese Seite auf Deutsch anzeigen');
        break;
      case 'fr':
        $links[$langcode]['title'] = t('Voir cette page en français');
        break;
      case 'es':
        $links[$langcode]['title'] = t('Ver esta página en español');
        break;
      case 'pt':
      case 'pt-br':
      case 'pt-pt':
        $links[$langcode]['title'] = t('Veja esta página em Português');
        break;
      case 'zh-cn':
      case 'zh-hans':
        $links[$langcode]['title'] = t('以中文浏览此页');
        break;
    }
  }
}

/**
 * Implements hook_block_info().
 */
function iied_features_block_info() {
  $blocks['iied_features'] = array(
    // The name that will appear in the block list.
    'info' => t('Sharing links'),
    // Default setting.
    'cache' => DRUPAL_NO_CACHE,
  );
  return $blocks;
}

/**
 * Implements hook_block_view().
 * TODO: Add footer scope
*/

function iied_features_block_view($delta = '') {
  $block = array();
  switch ($delta) {
    case 'iied_features':
      $pageUrl = url(drupal_get_path_alias(current_path()), array('absolute' => TRUE));
      $title = drupal_get_title();
      $block['subject'] = t('Share this page');
      $block['content'] = array(
        '#markup' => iied_features_content($pageUrl, $title),
      );
       $path = drupal_get_path('module', 'iied_features');
       drupal_add_css($path . "/iied_features.css");
       drupal_add_js(array('iiedFeatures' => array('pageUrl' => $pageUrl)), 'setting');
       drupal_add_js($path . '/iied_features.js', array('scope' => 'footer'));
      break;
  }
  return $block;
}

function iied_features_content($lnk, $ttl) {
  $facebook = '<li><i class="fa fa-facebook"></i><a target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=' . $lnk . '" title="'. $ttl . '">&nbsp;' . t("Share") . '</a></li>';
  $twitter = '<li><i class="twitter fa fa-twitter"></i><a target="_blank" href="https://twitter.com/share?text=' . urlencode($ttl) . '&url=' . $lnk . '">&nbsp;' . t("Tweet") . '</a></li>';
  $linkedin = '<li><i class="fa fa-linkedin"></i><a target="_blank" href="https://www.linkedin.com/sharing/share-offsite/?url=' . $lnk . '&title=' . urlencode($ttl) . '&source=LinkedIn">&nbsp;' . t("Share") . '</a></li>';
  $email = '<li><i class="fa fa-envelope"></i><a title="Email" href="mailto:?subject=' . $ttl . '&body=' . t('I thought you might enjoy this from IIED:') . '%0D%0A%0D%0A' . $lnk .'">&nbsp;' . t("Email") . '</a></li>';
  $copy = '<li><i class="fa fa-link"></i><a class="js-copy-url" href="#">&nbsp;Copy link</a></li>';
  $content = '<div class="iiedFeatures"><ul>' . $facebook . $twitter . $linkedin . $email . $copy . '</ul></div>';
  return $content;
}
